# T-014 "ë””ìŠ¤í”Œë ˆì´ ë“±ë¡, í˜ì–´ë§ ë° íŠ¸ë¦¬ê±° API" - ì„¤ê³„ ì™„ë£Œ ìš”ì•½

## ğŸ“Œ ë¹ ë¥¸ ì°¸ì¡°

### ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸

| ë©”ì„œë“œ | ê²½ë¡œ | ì„¤ëª… | ì¸ì¦ | ë ˆì´íŠ¸ ì œí•œ |
|--------|------|------|------|-----------|
| POST | `/api/displays/register` | ë””ìŠ¤í”Œë ˆì´ ë“±ë¡/ì—…ë°ì´íŠ¸ | ì„ íƒ | IP: ë¶„ë‹¹ 60íšŒ |
| GET | `/api/displays` | ë””ìŠ¤í”Œë ˆì´ ëª©ë¡ ì¡°íšŒ | í•„ìˆ˜ | IP: ë¶„ë‹¹ 300íšŒ |
| POST | `/api/pair/qr` | í˜ì–´ë§ QR ìƒì„± | ì„ íƒ | IP: ë¶„ë‹¹ 20íšŒ |
| GET | `/api/pair/poll/:sessionId` | í˜ì–´ë§ í´ë§ (Long Polling) | ì„ íƒ | IP: ë¶„ë‹¹ 20íšŒ |
| POST | `/api/pair/approve` | í˜ì–´ë§ ìŠ¹ì¸ | í•„ìˆ˜ | IP: ë¶„ë‹¹ 10íšŒ |
| POST | `/api/trigger` | íŠ¸ë¦¬ê±° ì „ì†¡ | í•„ìˆ˜ | IP: ì´ˆë‹¹ 10íšŒ / ì‚¬ìš©ì: ë¶„ë‹¹ 100íšŒ |

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”

### displays (í˜„ì¬ ë””ìŠ¤í”Œë ˆì´ ìƒíƒœ)
```
í•„ë“œ: id, device_id*, screen_id*, name, purpose, org_id, line_id, status, last_seen_at, created_at, updated_at
ì¸ë±ìŠ¤: device_id, screen_id, line_id, status, last_seen_at DESC, (org_id, line_id)
ìš©ë„: ë“±ë¡ëœ ëª¨ë“  ë””ìŠ¤í”Œë ˆì´ì˜ í˜„ì¬ ìƒíƒœ ë° ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ì¶”ì 
```

### pair_sessions (ì„ì‹œ í˜ì–´ë§ ì„¸ì…˜)
```
í•„ë“œ: id, session_id*, code, status, device_id, org_id, line_id, token, approved_by, expires_at, created_at, updated_at
ì¸ë±ìŠ¤: session_id, status, expires_at DESC, code
ìš©ë„: í˜ì–´ë§ í”„ë¡œì„¸ìŠ¤ ì„ì‹œ ë°ì´í„° (5ë¶„ TTL)
ì •ë¦¬: ìë™ ë§Œë£Œ ë˜ëŠ” ì •ê¸° ì •ë¦¬
```

### trigger_logs (ê°ì‹œ ë° ê°ì‚¬ ë¡œê·¸)
```
í•„ë“œ: id, tx_id*, user_id, screen_id, job_no, status, client_count, ip_address, user_agent, timestamp
ì¸ë±ìŠ¤: tx_id, user_id, screen_id, status, timestamp DESC, (user_id, screen_id)
ìš©ë„: ëª¨ë“  íŠ¸ë¦¬ê±° í˜¸ì¶œ ê¸°ë¡ (ì˜êµ¬ ë³´ê´€)
ë³´ê´€: 90ì¼ ì´ìƒ ì•„ì¹´ì´ë¹™ ê¶Œì¥
```

---

## ğŸ” ì¸ì¦ & ê¶Œí•œ

### JWT í† í° êµ¬ì¡° (ë””ìŠ¤í”Œë ˆì´)
```json
{
  "sub": "display:screen:org-id:line-id",
  "type": "display",
  "scopes": ["display:screen:org-id:line-id"],
  "deviceId": "uuid-xxx",
  "iat": 1729858225,
  "exp": 1729858825
}
```

### í•„ìˆ˜ ë¯¸ë“¤ì›¨ì–´
1. **expressAuthMiddleware**: Bearer í† í° ê²€ì¦
2. **rateLimitMiddleware**: ì—”ë“œí¬ì¸íŠ¸ë³„ ì„¸ë¶„í™”ëœ ì œí•œ
3. **validationMiddleware**: Zod ìŠ¤í‚¤ë§ˆ ê²€ì¦

---

## ğŸ“Š ì‘ë‹µ í‘œì¤€í™”

### ì„±ê³µ ì‘ë‹µ
```typescript
{
  ok: true,
  [data_field]: value,  // screenId, token, displays ë“±
  message?: string,     // ì„ íƒì‚¬í•­
}
```

### ì—ëŸ¬ ì‘ë‹µ
```typescript
{
  ok: false,
  reason: string,       // snake_case (validation_error, forbidden, rate_limit_exceeded ë“±)
  message: string,      // ì‚¬ëŒ ì¹œí™”ì  ë©”ì‹œì§€
  errors?: Array<{      // ê²€ì¦ ì—ëŸ¬ ì‹œì—ë§Œ
    field: string,
    message: string,
  }>,
  retryAfter?: number,  // ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ… ì‹œì—ë§Œ
}
```

### HTTP ìƒíƒœ ì½”ë“œ
- **200**: ì„±ê³µ
- **400**: ê²€ì¦ ì‹¤íŒ¨, ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜/ì½”ë“œ
- **401**: ì¸ì¦ í•„ìš” ë˜ëŠ” í† í° ë¬´íš¨
- **403**: ê¶Œí•œ ë¶€ì¡±
- **404**: ë¦¬ì†ŒìŠ¤ ì—†ìŒ
- **409**: ë””ë°”ì´ìŠ¤ ì¶©ëŒ
- **410**: ì„¸ì…˜/í† í° ë§Œë£Œ
- **429**: ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ… ì´ˆê³¼
- **503**: ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ

---

## âš¡ ì„±ëŠ¥ ëª©í‘œ

| ë©”íŠ¸ë¦­ | ëª©í‘œ | ë°©ë²• |
|--------|------|------|
| ì‘ë‹µì‹œê°„ p95 | <100ms | ì¸ë±ìŠ¤ ìµœì í™”, ë¹„ë™ê¸° ì²˜ë¦¬ |
| ë™ì‹œ ì—°ê²° | 1000+ | Redis ìŠ¤í† ì–´, ìˆ˜í‰ í™•ì¥ |
| íŠ¸ë¦¬ê±° ì§€ì—° | <50ms | ë¹„ë™ê¸° ë©”ì‹œì§€ í |
| DB ì¿¼ë¦¬ | <10ms | ì¸ë±ìŠ¤ ì „ëµ |

---

## ğŸ”„ ìƒíƒœ ê´€ë¦¬

### ë””ìŠ¤í”Œë ˆì´ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ íŒì •
```
- ì˜¨ë¼ì¸: last_seen_atì´ 60ì´ˆ ì´ë‚´ (SELECT * WHERE last_seen_at > NOW() - 60s)
- ì˜¤í”„ë¼ì¸: 60ì´ˆ ì´ìƒ ë¯¸ê°±ì‹  (ìƒíƒœ ì»¬ëŸ¼ ì—…ë°ì´íŠ¸)
- ìë™ ì •ë¦¬: 30ë¶„+ offline ìƒíƒœì¼ ë•Œ status='offline'ìœ¼ë¡œ ë³€ê²½
- ì•„ì¹´ì´ë¸Œ: 90ì¼+ offline ìƒíƒœì¼ ë•Œ ì‚­ì œ ê³ ë ¤
```

### í˜ì–´ë§ ì„¸ì…˜ ìƒëª…ì£¼ê¸°
```
1. QR ìƒì„± (POST /api/pair/qr)
   - UUID ì„¸ì…˜ID ìƒì„±
   - 6ìë¦¬ ì½”ë“œ ìƒì„±
   - TTL 5ë¶„ ì„¤ì • (expires_at = now + 5ë¶„)

2. í´ë§ (GET /api/pair/poll/:sessionId) - Long Polling 30ì´ˆ
   - í´ë¼ì´ì–¸íŠ¸: 30ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
   - ìƒíƒœ 'pending' ìœ ì§€ ì¤‘...
   - ìƒíƒœ 'approved' ë˜ë©´ í† í° ë°˜í™˜

3. ìŠ¹ì¸ (POST /api/pair/approve)
   - ì½”ë“œ ê²€ì¦
   - í† í° ìƒì„± (exp: 10ë¶„)
   - status='approved'ë¡œ ë³€ê²½
   - ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥

4. ì •ê¸° ì •ë¦¬ (Cron Job)
   - expires_at < NOW()ì¸ ë ˆì½”ë“œ ì‚­ì œ
   - 5ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰ ê¶Œì¥
```

### íŠ¸ë¦¬ê±° íë¦„
```
1. í´ë¼ì´ì–¸íŠ¸: POST /api/trigger (screenId, jobNo)
   â†“
2. ì„œë²„:
   - ì…ë ¥ ê²€ì¦
   - ê¶Œí•œ í™•ì¸ (display:screenId ìŠ¤ì½”í”„)
   - Socket.IOë¡œ ë©”ì‹œì§€ ì „ì†¡ (emitToChannel)
   - txId ê¸°ë°˜ ì¤‘ë³µ ê²€ì‚¬
   â†“
3. ë¡œê·¸:
   - ì¦‰ì‹œ ì‘ë‹µ (í´ë¼ì´ì–¸íŠ¸ ìˆ˜ í¬í•¨)
   - ë¹„ë™ê¸°ë¡œ trigger_logs ê¸°ë¡
   â†“
4. ê²°ê³¼:
   - 200: ë©”ì‹œì§€ ì „ì†¡ë¨
   - 503: ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ
   - 429: ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ…
```

---

## ğŸ“‹ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: ê¸°ë³¸ êµ¬ì¡° (1ì¼)
- [ ] Express ë¼ìš°í„° ë¶„ë¦¬ (routes/)
- [ ] expressAuthMiddleware êµ¬í˜„
- [ ] Zod ê²€ì¦ ìŠ¤í‚¤ë§ˆ (schemas/)
- [ ] ì—ëŸ¬ ì‘ë‹µ í‘œì¤€í™”
- [ ] ë¡œê¹… ì„¤ì •

### Phase 2: API êµ¬í˜„ (2ì¼)
- [ ] POST /api/displays/register
- [ ] GET /api/displays
- [ ] POST /api/pair/qr
- [ ] GET /api/pair/poll/:sessionId
- [ ] POST /api/pair/approve
- [ ] POST /api/trigger (emitToChannel í†µí•©)

### Phase 3: ë°ì´í„° ì €ì¥ì†Œ (1ì¼)
- [ ] IDataStore ì¸í„°í˜ì´ìŠ¤ ì •ì˜
- [ ] MemoryStore êµ¬í˜„ (ê°œë°œ/í…ŒìŠ¤íŠ¸)
- [ ] SqliteStore êµ¬í˜„ (í”„ë¡œí† íƒ€ì…)
- [ ] PostgresStore êµ¬í˜„ (í”„ë¡œë•ì…˜)

### Phase 4: ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ… & ë³´ì•ˆ (0.5ì¼)
- [ ] ì—”ë“œí¬ì¸íŠ¸ë³„ ë ˆì´íŠ¸ ë¦¬ë¯¸í„°
- [ ] Zod ê²€ì¦ ê°•í™”
- [ ] SQL ì¸ì ì…˜ ë°©ì§€
- [ ] ì •ê¸° ì •ë¦¬ ì‘ì—… (Cron)

### Phase 5: í…ŒìŠ¤íŠ¸ (1.5ì¼)
- [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] í†µí•© í…ŒìŠ¤íŠ¸ (API + Socket.IO)
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
- [ ] E2E í…ŒìŠ¤íŠ¸

---

## ğŸ”§ íŒŒì¼ êµ¬ì¡° (ì˜ˆìƒ)

```
server/src/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ displays.ts          # POST /api/displays/register, GET /api/displays
â”‚   â”œâ”€â”€ pairing.ts           # POST /api/pair/qr, GET /api/pair/poll, POST /api/pair/approve
â”‚   â””â”€â”€ triggers.ts          # POST /api/trigger
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth.ts              # expressAuthMiddleware (Bearer í† í°)
â”‚   â”œâ”€â”€ rateLimit.ts         # ì—”ë“œí¬ì¸íŠ¸ë³„ ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ…
â”‚   â””â”€â”€ validation.ts        # Zod ê²€ì¦
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ displays.ts
â”‚   â”œâ”€â”€ pairing.ts
â”‚   â””â”€â”€ triggers.ts
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ displayService.ts    # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”œâ”€â”€ pairingService.ts
â”‚   â””â”€â”€ triggerService.ts
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ types.ts             # IDataStore ì¸í„°í˜ì´ìŠ¤
â”‚   â”œâ”€â”€ memoryStore.ts
â”‚   â”œâ”€â”€ sqliteStore.ts
â”‚   â””â”€â”€ postgresStore.ts
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ errors.ts            # ì—ëŸ¬ ì‘ë‹µ í—¬í¼
â”‚   â””â”€â”€ validators.ts        # ì •ê·œì‹ ë“±
â””â”€â”€ index.ts                 # Express ì•± ì„¤ì •
```

---

## ğŸš€ ë°°í¬ ë‹¨ê³„

### 1ë‹¨ê³„: ì¸ë©”ëª¨ë¦¬ (ê°œë°œ)
```bash
DB_TYPE=memory npm run dev
```

### 2ë‹¨ê³„: SQLite (í…ŒìŠ¤íŠ¸)
```bash
DB_TYPE=sqlite DB_PATH=./app.db npm start
```

### 3ë‹¨ê³„: PostgreSQL (í”„ë¡œë•ì…˜)
```bash
DB_TYPE=postgres \
DATABASE_URL=postgresql://user:pass@host:5432/db \
npm start
```

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

| ë¬¸ì„œ | ë‚´ìš© |
|------|------|
| `T-014_API_ì„¤ê³„.md` | ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ìƒì„¸ ì„¤ê³„ + êµ¬í˜„ ì˜ˆì œ |
| `T-014_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md` | SQL ì¿¼ë¦¬ + ë§ˆì´ê·¸ë ˆì´ì…˜ + ëª¨ë‹ˆí„°ë§ |
| `T-014_ì•„í‚¤í…ì²˜ë¶„ì„.md` | ê¸°ì¡´ ì½”ë“œë² ì´ìŠ¤ ë¶„ì„ + í†µí•© ì„¤ê³„ |
| `T-014_êµ¬í˜„ì„¸ë¶€ê°€ì´ë“œ.md` | ì½”ë“œ ì˜ˆì œ + í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ |

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **screenId í˜•ì‹**: `screen:<orgId>:<lineId>` (ì •ê·œì‹: `^screen:[a-f0-9-]+:[a-f0-9-]+$`)
2. **heartbeat ê°„ê²©**: 30ì´ˆ (60ì´ˆ offline threshold ì•ˆì „)
3. **í˜ì–´ë§ ì½”ë“œ**: 6ìë¦¬ ìˆ«ì (0-999999)
4. **í† í° ë§Œë£Œ**: ë””ìŠ¤í”Œë ˆì´ 10ë¶„, ì‚¬ìš©ì 1ì‹œê°„
5. **ì˜¨ë¼ì¸ íŒì •**: 60ì´ˆ ì´ë‚´ last_seen_at
6. **ì •ê¸° ì •ë¦¬**: 30ë¶„+ offline â†’ offline ìƒíƒœ, 90ì¼+ â†’ ì‚­ì œ
7. **txId**: UUID (ì¤‘ë³µ ë¶ˆê°€ëŠ¥, ë©±ë“±ì„± ë³´ì¥)

---

## ğŸ” í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ë””ìŠ¤í”Œë ˆì´ ë“±ë¡
```bash
curl -X POST http://localhost:3000/api/displays/register \
  -H "Content-Type: application/json" \
  -d '{
    "deviceId": "550e8400-e29b-41d4-a716-446655440000",
    "name": "Pack Line 1",
    "purpose": "work_instruction",
    "orgId": "org-123",
    "lineId": "line-456"
  }'

# ì‘ë‹µ: { ok: true, screenId: "screen:org-123:line-456", status: "registered" }
```

### 2. í˜ì–´ë§ ì‹œì‘
```bash
curl -X POST http://localhost:3000/api/pair/qr

# ì‘ë‹µ: { ok: true, sessionId: "uuid...", qrData: "{...}" }
```

### 3. í˜ì–´ë§ í´ë§
```bash
curl http://localhost:3000/api/pair/poll/550e8400-e29b-41d4-a716-446655440000 \
  --max-time 35

# 30ì´ˆ ëŒ€ê¸° í›„ timeout ë˜ëŠ” token ë°˜í™˜
```

### 4. í˜ì–´ë§ ìŠ¹ì¸ (ê´€ë¦¬ì)
```bash
curl -X POST http://localhost:3000/api/pair/approve \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <admin-jwt>" \
  -d '{
    "sessionId": "550e8400-e29b-41d4-a716-446655440000",
    "code": "123456"
  }'

# ì‘ë‹µ: { ok: true, token: "jwt-token...", screenId: "screen:org-123:line-456" }
```

### 5. íŠ¸ë¦¬ê±° ì „ì†¡
```bash
curl -X POST http://localhost:3000/api/trigger \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <display-jwt>" \
  -d '{
    "screenId": "screen:org-123:line-456",
    "jobNo": "ORDER-12345",
    "priority": "high"
  }'

# ì‘ë‹µ: { ok: true, txId: "uuid...", clientCount: 5, message: "íŠ¸ë¦¬ê±°ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤" }
```

---

## ğŸ“ ê°œë°œíŒ€ ì—°ë½ì²˜

| ì—­í•  | ë‹´ë‹¹ |
|------|------|
| ì•„í‚¤í…ì²˜ | ì´ ë¬¸ì„œ ì°¸ì¡° |
| êµ¬í˜„ | T-014_êµ¬í˜„ì„¸ë¶€ê°€ì´ë“œ.md |
| í…ŒìŠ¤íŠ¸ | T-014 í…ŒìŠ¤íŠ¸ ê³„íš |
| ë°°í¬ | DEPLOYMENT.md |

---

**ì„¤ê³„ ì™„ë£Œ ë‚ ì§œ:** 2025-10-25
**ë²„ì „:** 1.0
**ìƒíƒœ:** êµ¬í˜„ ì¤€ë¹„ ì™„ë£Œ
